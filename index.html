<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æšæ°´è©¦é¨“è§£æãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 10px; background: #f0f2f5; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2, h3 { color: #1a73e8; margin-top: 0; }
        label { display: block; font-size: 0.9em; font-weight: bold; margin-top: 10px; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { flex: 1; min-width: 120px; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .btn-calc { background: #1a73e8; color: white; }
        .btn-csv { background: #34a853; color: white; }
        .btn-pdf { background: #ea4335; color: white; }
        .result-box { background: #e8f0fe; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¢ ç¾å ´æƒ…å ±ãƒ»æ¡ä»¶å…¥åŠ›</h2>
    <label>ç¾å ´åç§°</label><input type="text" id="siteName" placeholder="ä¾‹ï¼šã€‡ã€‡å·¥äº‹ç¾å ´">
    <label>åœ°ç‚¹å</label><input type="text" id="pointName" placeholder="ä¾‹ï¼šNo.1 è¦³æ¸¬äº•">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div><label>æšæ°´é‡ (L/min)</label><input type="number" id="inputQ_L" value="60"></div>
        <div><label>è¦³æ¸¬è·é›¢ r (m)</label><input type="number" id="inputR" value="10"></div>
        <div><label>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é•· (m)</label><input type="number" id="inputL" value="5"></div>
        <div><label>é–‹å§‹å‰æ°´ä½ (G.L.-m)</label><input type="number" id="baseWL" value="2.50" step="0.01"></div>
    </div>
</div>

<div class="card">
    <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ï¼ˆæ™‚é–“ãƒ»æ°´ä½ï¼‰</h3>
    <p style="font-size:0.8em; color:#666;">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ã¾ãŸã¯Excelã‹ã‚‰è²¼ã‚Šä»˜ã‘å¯èƒ½ã€‚ä¸€åº¦ä¿å­˜ã—ãŸCSVã®å†èª­ã¿è¾¼ã¿ã‚‚å¯¾å¿œã€‚</p>
    <textarea id="dataInput" style="width:100%; height:120px; padding:10px;" placeholder="çµŒéæ™‚é–“(åˆ†) æ°´ä½(G.L.-m)&#10;1  2.65&#10;2  2.80&#10;5  3.10..."></textarea>
    <div class="btn-group">
        <input type="file" id="csvFile" style="display:none" accept=".csv">
        <button class="btn-csv" onclick="document.getElementById('csvFile').click()">CSVèª­è¾¼</button>
        <button class="btn-calc" onclick="runAnalysis()">è§£æãƒ»ã‚°ãƒ©ãƒ•æ›´æ–°</button>
    </div>
</div>

<div id="resultsArea" class="card" style="display:none;">
    <h3>ğŸ“Š è§£æçµæœ</h3>
    <div class="result-box">
        <div>é€æ°´é‡ä¿‚æ•° T<br><span id="resT" style="font-weight:bold; color:#1a73e8;">-</span> mÂ²/s</div>
        <div>é€æ°´ä¿‚æ•° k<br><span id="resK" style="font-weight:bold; color:#1a73e8;">-</span> m/s</div>
        <div>è²¯ç•™ä¿‚æ•° S<br><span id="resS" style="font-weight:bold; color:#1a73e8;">-</span> [-]</div>
        <div>æ±ºå®šä¿‚æ•° RÂ²<br><span id="resR2" style="font-weight:bold; color:#1a73e8;">-</span></div>
    </div>
    <div id="plotHydro" style="margin-top:20px;"></div>
    <div id="plotJacob" style="margin-top:20px;"></div>
    <div class="btn-group">
        <button class="btn-csv" onclick="exportCSV()">CSVä¿å­˜</button>
        <button class="btn-pdf" onclick="exportPDF()">PDFä¿å­˜</button>
    </div>
</div>

<script>
let globalData = [];

function runAnalysis() {
    const text = document.getElementById('dataInput').value.trim();
    const baseWL = parseFloat(document.getElementById('baseWL').value);
    const Q_m3s = parseFloat(document.getElementById('inputQ_L').value) / 1000 / 60;
    const r = parseFloat(document.getElementById('inputR').value);
    const L = parseFloat(document.getElementById('inputL').value);

    // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
    const rows = text.split(/\n/);
    globalData = rows.map(row => {
        const cols = row.split(/[\s,t]+/).map(v => parseFloat(v));
        return { t: cols[0], wl: cols[1], s: cols[1] - baseWL };
    }).filter(d => !isNaN(d.t) && !isNaN(d.wl));

    if (globalData.length < 3) return alert("ãƒ‡ãƒ¼ã‚¿ã‚’3ä»¶ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

    // Jacobæ³•è¨ˆç®—
    const logT = globalData.map(d => Math.log10(d.t));
    const points = logT.map((x, i) => [x, globalData[i].s]);
    const reg = ss.linearRegression(points);
    const lre = ss.linearRegressionLine(reg);
    const r2 = ss.rSquared(points, lre);

    const deltaS = reg.m; 
    const T = 0.183 * Q_m3s / deltaS;
    const k = T / L;
    const t0 = Math.pow(10, -reg.b / reg.m);
    const S = 2.25 * T * (t0 * 60) / Math.pow(r, 2);

    // è¡¨ç¤ºæ›´æ–°
    document.getElementById('resultsArea').style.display = 'block';
    document.getElementById('resT').innerText = T.toExponential(3);
    document.getElementById('resK').innerText = k.toExponential(3);
    document.getElementById('resS').innerText = S.toExponential(3);
    document.getElementById('resR2').innerText = r2.toFixed(4);

    // ã‚°ãƒ©ãƒ•æç”»ï¼ˆæ°´ä½å¤‰å‹•å›³ï¼‰
    Plotly.newPlot('plotHydro', [{
        x: globalData.map(d => d.t), y: globalData.map(d => d.wl), name: 'æ°´ä½', line: {shape: 'spline'}
    }], { title: 'æ°´ä½å¤‰å‹•ã‚°ãƒ©ãƒ•', xaxis: {title: 'æ™‚é–“ (min)'}, yaxis: {title: 'æ°´ä½ (G.L.-m)', autorange: 'reverse'} });

    // ã‚°ãƒ©ãƒ•æç”»ï¼ˆJacobæ³•ï¼‰
    Plotly.newPlot('plotJacob', [
        { x: logT, y: globalData.map(d => d.s), mode: 'markers', name: 'ä½ä¸‹é‡' },
        { x: logT, y: logT.map(x => lre(x)), mode: 'lines', name: 'Fit' }
    ], { title: 'Jacobæ³•è§£æ', xaxis: {title: 'log10(t [min])'}, yaxis: {title: 'ä½ä¸‹é‡ s [m]'} });
}

// CSVèª­ã¿è¾¼ã¿
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    Papa.parse(file, {
        complete: function(res) {
            const dataRows = res.data.filter(r => !isNaN(parseFloat(r[0])));
            document.getElementById('dataInput').value = dataRows.map(r => `${r[0]} ${r[1]}`).join('\n');
            runAnalysis();
        }
    });
});

function exportCSV() {
    const site = document.getElementById('siteName').value;
    const header = "Time(min),WaterLevel(m),Drawdown(m)\n";
    const body = globalData.map(d => `${d.t},${d.wl},${d.s}`).join("\n");
    const blob = new Blob([header + body], {type: 'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${site}_analysis.csv`; a.click();
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(`æšæ°´è©¦é¨“è§£æå ±å‘Šæ›¸: ${document.getElementById('siteName').value}`, 10, 10);
    doc.text(`åœ°ç‚¹å: ${document.getElementById('pointName').value}`, 10, 20);
    doc.autoTable({
        startY: 30,
        head: [['é …ç›®', 'å€¤']],
        body: [
            ['é€æ°´é‡ä¿‚æ•° T', document.getElementById('resT').innerText + ' m2/s'],
            ['é€æ°´ä¿‚æ•° k', document.getElementById('resK').innerText + ' m/s'],
            ['è²¯ç•™ä¿‚æ•° S', document.getElementById('resS').innerText],
            ['æ±ºå®šä¿‚æ•° R2', document.getElementById('resR2').innerText]
        ]
    });
    doc.save("report.pdf");
}
</script>
</body>
</html>
