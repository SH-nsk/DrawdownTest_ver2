<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquifer Test Analysis (Jacob & Theis)</title>
    <!-- Library Imports -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: #3c4043; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 15px; }
        h2, h3 { color: var(--primary); margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #e8f0fe; padding-bottom: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #5f6368; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { flex: 1; min-width: 100px; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-csv { background: var(--success); color: white; }
        .btn-pdf { background: var(--danger); color: white; }
        .btn-load { background: #5f6368; color: white; }
        .result-box { background: #e8f0fe; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .res-item { text-align: center; border: 1px solid #c2d7fa; padding: 10px; border-radius: 6px; background: white; }
        .res-val { font-size: 1.1rem; font-weight: bold; color: var(--primary); display: block; margin-top: 4px; }
        .instruction { background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0; font-size: 0.9rem; }
        #plotHydro, #plotJacob, #plotTheis { width: 100%; min-height: 400px; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }
        .hidden { display: none; }
        @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ¢ ç¾å ´æƒ…å ±ãƒ»æ¡ä»¶å…¥åŠ›</h2>
        <div class="grid">
            <div style="grid-column: span 2;">
                <label>ç¾å ´åç§°</label>
                <input type="text" id="siteName" placeholder="ã€‡ã€‡å»ºè¨­ç¾å ´">
            </div>
            <div>
                <label>åœ°ç‚¹å</label>
                <input type="text" id="pointName" placeholder="Observation Well No.1">
            </div>
            <div>
                <label>æšæ°´é‡ Q (L/min)</label>
                <input type="number" id="inputQ_L" value="60">
            </div>
            <div>
                <label>è¦³æ¸¬è·é›¢ r (m)</label>
                <input type="number" id="inputR" value="10" step="0.1">
            </div>
            <div>
                <label>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é•· L (m)</label>
                <input type="number" id="inputL" value="5" step="0.1">
            </div>
            <div>
                <label>é–‹å§‹å‰æ°´ä½ (G.L.-m)</label>
                <input type="number" id="baseWL" value="2.50" step="0.01">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h3>
        <label>æ™‚é–“(åˆ†) ã¨ æ°´ä½(G.L.-m) ã‚’å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã¾ãŸã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <textarea id="dataInput" rows="8" placeholder="1  2.65&#10;2  2.80&#10;5  3.10&#10;10 3.35..."></textarea>
        <div class="btn-group">
            <input type="file" id="csvFile" class="hidden" accept=".csv">
            <button class="btn-load" onclick="document.getElementById('csvFile').click()">CSVèª­è¾¼</button>
            <button class="btn-calc" onclick="initializeAnalysis()">è§£æé–‹å§‹ï¼ˆã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼‰</button>
        </div>
    </div>

    <div id="resultsArea" class="card hidden">
        <h3>ğŸ“Š è§£æçµæœ</h3>
        <div class="instruction" id="fitInstruct">
            <strong>ã€æ“ä½œã‚¬ã‚¤ãƒ‰ã€‘</strong> ä¸‹ã®ã€Œãƒ¤ã‚³ãƒ–æ³•è§£æå›³ã€ã®ã‚°ãƒ©ãƒ•ä¸Šã§ã€ç›´ç·šåŒºé–“ã®<strong>é–‹å§‹ç‚¹</strong>ã¨<strong>çµ‚äº†ç‚¹</strong>ã®2ç®‡æ‰€ã‚’ã‚¿ãƒƒãƒ—ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ã—ã¦è§£æç¯„å›²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
        </div>
        
        <div class="result-box">
            <div class="res-item">é€æ°´é‡ä¿‚æ•° T [mÂ²/s]<span id="resT" class="res-val">-</span></div>
            <div class="res-item">é€æ°´ä¿‚æ•° k [m/s]<span id="resK" class="res-val">-</span></div>
            <div class="res-item">è²¯ç•™ä¿‚æ•° S [-]<span id="resS" class="res-val">-</span></div>
            <div class="res-item">æ±ºå®šä¿‚æ•° RÂ²<span id="resR2" class="res-val">-</span></div>
        </div>

        <div id="plotJacob"></div>
        <div id="plotTheis"></div>
        <div id="plotHydro"></div>

        <div class="btn-group">
            <button class="btn-csv" onclick="exportCSV()">CSVä¿å­˜</button>
            <button class="btn-pdf" onclick="exportPDF()">PDFå‡ºåŠ›</button>
        </div>
    </div>
</div>

<script>
let globalData = [];
let analysisResults = {};
let selectedPoints = []; // Clicked points indices

/**
 * äº•æˆ¸é–¢æ•° W(u) ã®è¿‘ä¼¼è¨ˆç®—
 */
function wellFunction(u) {
    if (u <= 0) return 0;
    // å°ã•ã„uã«å¯¾ã™ã‚‹å¤šé …å¼è¿‘ä¼¼ã¨ç´šæ•°å±•é–‹ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰
    const eulerGamma = 0.5772156649;
    if (u < 1) {
        let term = u;
        let sum = u;
        for (let n = 2; n < 20; n++) {
            term *= (-u) * (n - 1) / (n * n);
            sum += term;
        }
        return -eulerGamma - Math.log(u) + sum;
    } else {
        // å¤§ãã„uã«å¯¾ã™ã‚‹è¿‘ä¼¼
        const a = [0.2677737343, 8.6347608925, 18.0590173560, 8.5242330240];
        const b = [3.9684967471, 21.0944531382, 25.6329561486, 9.5733223454];
        let num = 0, den = 1;
        for(let i=0; i<4; i++){
            num = num * u + a[i];
            den = den * u + b[i];
        }
        return (Math.exp(-u) / u) * (num / den);
    }
}

/**
 * ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨åˆæœŸæç”»
 */
function initializeAnalysis() {
    const text = document.getElementById('dataInput').value.trim();
    const baseWL = parseFloat(document.getElementById('baseWL').value);

    if (!text) return alert("ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãŒå¿…è¦ã§ã™");

    const rows = text.split(/\n/);
    globalData = rows.map((row, idx) => {
        const cols = row.trim().split(/[\s,t]+/).map(v => parseFloat(v));
        if (cols.length >= 2 && !isNaN(cols[0]) && !isNaN(cols[1])) {
            return { id: idx, t: cols[0], wl: cols[1], s: cols[1] - baseWL };
        }
        return null;
    }).filter(d => d !== null && d.t > 0);

    if (globalData.length < 3) return alert("ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");

    selectedPoints = []; // é¸æŠãƒªã‚»ãƒƒãƒˆ
    document.getElementById('resultsArea').classList.remove('hidden');
    
    // åˆå›ã‚°ãƒ©ãƒ•æç”»ï¼ˆãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ãªã—ï¼‰
    drawHydrograph();
    drawJacobPlot([]);
    document.getElementById('plotTheis').innerHTML = ""; // ã‚¿ã‚¤ã‚¹å›³ã¯è¨ˆç®—å¾Œ
}

/**
 * æ°´ä½å¤‰å‹•ã‚°ãƒ©ãƒ•ï¼ˆåè»¢è»¸ï¼‰
 */
function drawHydrograph() {
    const trace = {
        x: globalData.map(d => d.t),
        y: globalData.map(d => d.wl),
        mode: 'lines+markers',
        name: 'è¦³æ¸¬æ°´ä½',
        line: { color: '#1a73e8' }
    };
    const layout = {
        title: 'æ°´ä½å¤‰å‹•ã‚°ãƒ©ãƒ•',
        xaxis: { title: 'çµŒéæ™‚é–“ (min)' },
        yaxis: { title: 'æ°´ä½ (G.L.-m)', autorange: 'reverse' }, // æ•°å­—ãŒå¤§ãã„æ–¹ãŒä¸‹
        margin: { t: 50, b: 50, l: 60, r: 30 }
    };
    Plotly.newPlot('plotHydro', [trace], layout);
}

/**
 * ãƒ¤ã‚³ãƒ–æ³•è§£æå›³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä»˜ï¼‰
 */
function drawJacobPlot(fitTrace = []) {
    const logT = globalData.map(d => Math.log10(d.t));
    const sArr = globalData.map(d => d.s);

    const traceData = {
        x: logT,
        y: sArr,
        mode: 'markers',
        name: 'å®Ÿæ¸¬ãƒ‡ãƒ¼ã‚¿',
        marker: { size: 10, color: '#5f6368' },
        customdata: globalData.map(d => d.id)
    };

    const layout = {
        title: 'ãƒ¤ã‚³ãƒ–æ³•è§£æå›³ (ç›´ç·šåŒºé–“ã‚’2ç‚¹ã‚¿ãƒƒãƒ—ã—ã¦æŒ‡å®š)',
        xaxis: { title: 'log10(çµŒéæ™‚é–“ [min])' },
        yaxis: { title: 'æ°´ä½ä½ä¸‹é‡ s [m]' },
        margin: { t: 50, b: 50, l: 60, r: 30 },
        hovermode: 'closest',
        showlegend: true
    };

    Plotly.newPlot('plotJacob', [traceData, ...fitTrace], layout);

    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²
    const plot = document.getElementById('plotJacob');
    plot.on('plotly_click', function(data){
        const pointIdx = data.points[0].pointIndex;
        handlePointSelection(pointIdx);
    });
}

/**
 * ç‚¹é¸æŠã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
 */
function handlePointSelection(idx) {
    selectedPoints.push(idx);
    
    if (selectedPoints.length === 1) {
        document.getElementById('fitInstruct').innerHTML = `<strong>ã€é¸æŠä¸­ã€‘</strong> 1ç‚¹ç›®ã‚’é¸æŠã—ã¾ã—ãŸï¼ˆIndex: ${idx}ï¼‰ã€‚æ¬¡ã«<strong>çµ‚äº†ç‚¹</strong>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚`;
    } else if (selectedPoints.length === 2) {
        document.getElementById('fitInstruct').innerHTML = `<strong>ã€è§£æå®Œäº†ã€‘</strong> ç¯„å›²ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚å†åº¦ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨åˆ¥ã®ç¯„å›²ã§å†è¨ˆç®—ã§ãã¾ã™ã€‚`;
        performJacobCalculation();
    } else {
        selectedPoints = [idx];
        document.getElementById('fitInstruct').innerHTML = `<strong>ã€é¸æŠä¸­ã€‘</strong> 1ç‚¹ç›®ã‚’é¸æŠã—ã¾ã—ãŸï¼ˆIndex: ${idx}ï¼‰ã€‚æ¬¡ã«<strong>çµ‚äº†ç‚¹</strong>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚`;
    }
}

/**
 * æŒ‡å®šã•ã‚ŒãŸç¯„å›²ã§ã®è¨ˆç®—å®Ÿè¡Œ
 */
function performJacobCalculation() {
    const start = Math.min(selectedPoints[0], selectedPoints[1]);
    const end = Math.max(selectedPoints[0], selectedPoints[1]);
    
    const Q_Lmin = parseFloat(document.getElementById('inputQ_L').value);
    const Q_m3s = Q_Lmin / 1000 / 60;
    const r = parseFloat(document.getElementById('inputR').value);
    const L = parseFloat(document.getElementById('inputL').value);
    const baseWL = parseFloat(document.getElementById('baseWL').value);

    // ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ç¯„å›²ã®ãƒ‡ãƒ¼ã‚¿
    const fitData = globalData.slice(start, end + 1);
    const logTFit = fitData.map(d => Math.log10(d.t));
    const sFit = fitData.map(d => d.s);
    const regressionPoints = logTFit.map((x, i) => [x, sFit[i]]);

    const reg = ss.linearRegression(regressionPoints);
    const lre = ss.linearRegressionLine(reg);
    const r2 = ss.rSquared(regressionPoints, lre);

    // æ°´ç†å®šæ•°
    const deltaS = reg.m; 
    const T = (0.183 * Q_m3s) / deltaS;
    const k = T / L;
    const logT0 = -reg.b / reg.m;
    const t0_min = Math.pow(10, logT0);
    const S = (2.25 * T * (t0_min * 60)) / Math.pow(r, 2);

    analysisResults = { T, k, S, r2, deltaS, t0_min, Q_m3s, Q_Lmin, r, L, baseWL };

    // çµæœè¡¨ç¤º
    document.getElementById('resT').innerText = T.toExponential(3);
    document.getElementById('resK').innerText = k.toExponential(3);
    document.getElementById('resS').innerText = S.toExponential(3);
    document.getElementById('resR2').innerText = r2.toFixed(4);

    // ãƒ¤ã‚³ãƒ–å›³ã«å›å¸°ç›´ç·šã‚’è¿½åŠ 
    const fullLogT = globalData.map(d => Math.log10(d.t));
    const fitLineTrace = {
        x: [Math.min(...fullLogT), Math.max(...fullLogT)],
        y: [lre(Math.min(...fullLogT)), lre(Math.max(...fullLogT))],
        mode: 'lines',
        name: 'Jacobè¿‘ä¼¼ç›´ç·š',
        line: { color: 'red', width: 3 }
    };
    const highlightTrace = {
        x: logTFit,
        y: sFit,
        mode: 'markers',
        name: 'è§£æå¯¾è±¡åŒºé–“',
        marker: { size: 12, color: 'red', symbol: 'circle-open' }
    };
    drawJacobPlot([fitLineTrace, highlightTrace]);

    // ã‚¿ã‚¤ã‚¹é©åˆç¢ºèªå›³ã®æç”»
    drawTheisPlot(T, S, Q_m3s, r);
}

/**
 * ã‚¿ã‚¤ã‚¹ç†è«–æ›²ç·šã¨ã®é©åˆç¢ºèªã‚°ãƒ©ãƒ•
 */
function drawTheisPlot(T, S, Q, r) {
    // æ™‚é–“è»¸ã‚’ç´°ã‹ãç”Ÿæˆã—ã¦æ›²ç·šã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹
    const times = globalData.map(d => d.t);
    const minT = Math.min(...times) * 0.5;
    const maxT = Math.max(...times) * 1.5;
    
    const curveT = [];
    const curveS = [];
    const steps = 100;
    const logMin = Math.log10(minT);
    const logMax = Math.log10(maxT);

    for (let i = 0; i <= steps; i++) {
        const t_min = Math.pow(10, logMin + (logMax - logMin) * (i / steps));
        const t_sec = t_min * 60;
        const u = (r * r * S) / (4 * T * t_sec);
        const Wu = wellFunction(u);
        const s_theo = (Q / (4 * Math.PI * T)) * Wu;
        curveT.push(t_min);
        curveS.push(s_theo);
    }

    const traceObs = {
        x: globalData.map(d => d.t),
        y: globalData.map(d => d.s),
        mode: 'markers',
        name: 'å®Ÿæ¸¬ä½ä¸‹é‡',
        marker: { color: '#5f6368' }
    };

    const traceTheo = {
        x: curveT,
        y: curveS,
        mode: 'lines',
        name: 'æ¨å®šã‚¿ã‚¤ã‚¹æ›²ç·š',
        line: { color: '#success', dash: 'dash', width: 2 }
    };

    const layout = {
        title: 'ã‚¿ã‚¤ã‚¹æ¨™æº–æ›²ç·šã¨ã®é©åˆç¢ºèª',
        xaxis: { title: 'çµŒéæ™‚é–“ (min)', type: 'log' },
        yaxis: { title: 'æ°´ä½ä½ä¸‹é‡ s [m]' },
        margin: { t: 50, b: 50, l: 60, r: 30 },
        legend: { orientation: 'h', y: -0.2 }
    };

    Plotly.newPlot('plotTheis', [traceObs, traceTheo], layout);
}

/**
 * CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 */
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: false,
        complete: function(results) {
            const rows = results.data;
            let dataLines = [];
            rows.forEach(row => {
                if (!row[0]) return;
                const cell = String(row[0]);
                if (cell.startsWith('# SITE:')) document.getElementById('siteName').value = cell.replace('# SITE:', '').trim();
                if (cell.startsWith('# Q_LMIN:')) document.getElementById('inputQ_L').value = cell.replace('# Q_LMIN:', '').trim();
                if (cell.startsWith('# R_M:')) document.getElementById('inputR').value = cell.replace('# R_M:', '').trim();
                if (cell.startsWith('# L_M:')) document.getElementById('inputL').value = cell.replace('# L_M:', '').trim();
                if (cell.startsWith('# BASEWL:')) document.getElementById('baseWL').value = cell.replace('# BASEWL:', '').trim();
                if (!isNaN(parseFloat(row[0])) && !isNaN(parseFloat(row[1]))) dataLines.push(`${row[0]},${row[1]}`);
            });
            document.getElementById('dataInput').value = dataLines.join('\n');
            initializeAnalysis();
        }
    });
});

function exportCSV() {
    const site = document.getElementById('siteName').value || 'site';
    let csvContent = [
        `# SITE: ${site}`,
        `# Q_LMIN: ${document.getElementById('inputQ_L').value}`,
        `# R_M: ${document.getElementById('inputR').value}`,
        `# L_M: ${document.getElementById('inputL').value}`,
        `# BASEWL: ${document.getElementById('baseWL').value}`,
        "Time(min),WaterLevel(m),Drawdown(m)"
    ].join("\n") + "\n";
    csvContent += globalData.map(d => `${d.t},${d.wl},${d.s}`).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `${site}_analysis.csv`;
    link.click();
}

/**
 * PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 */
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const site = document.getElementById('siteName').value || 'Unknown Site';
    doc.setFontSize(18);
    doc.text("Aquifer Test Analysis Report", 14, 20);
    doc.setFontSize(12);
    doc.text(`Site: ${site} / Point: ${document.getElementById('pointName').value}`, 14, 30);
    doc.autoTable({
        startY: 40,
        head: [['Property', 'Value', 'Unit']],
        body: [
            ['Pumping Rate (Q)', analysisResults.Q_Lmin, 'L/min'],
            ['Distance (r)', analysisResults.r, 'm'],
            ['Initial WL', analysisResults.baseWL, 'G.L.-m'],
            ['Transmissivity (T)', analysisResults.T ? analysisResults.T.toExponential(3) : '-', 'm2/s'],
            ['Hydraulic Conductivity (k)', analysisResults.k ? analysisResults.k.toExponential(3) : '-', 'm/s'],
            ['Storage Coefficient (S)', analysisResults.S ? analysisResults.S.toExponential(3) : '-', '-'],
            ['R-Squared', analysisResults.r2 ? analysisResults.r2.toFixed(4) : '-', '-']
        ]
    });
    doc.save(`${site}_report.pdf`);
}
</script>
</body>
</html>
