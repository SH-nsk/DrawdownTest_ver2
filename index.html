<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquifer Test Analysis (Jacob Method)</title>
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background: var(--bg); color: #3c4043; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 15px; }
        h2, h3 { color: var(--primary); margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #e8f0fe; padding-bottom: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: #5f6368; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { flex: 1; min-width: 100px; padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-csv { background: var(--success); color: white; }
        .btn-pdf { background: var(--danger); color: white; }
        .btn-load { background: #5f6368; color: white; }
        .result-box { background: #e8f0fe; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .res-item { text-align: center; border: 1px solid #c2d7fa; padding: 10px; border-radius: 6px; background: white; }
        .res-val { font-size: 1.1rem; font-weight: bold; color: var(--primary); display: block; margin-top: 4px; }
        #plotHydro, #plotJacob { width: 100%; min-height: 350px; margin-top: 10px; }
        .hidden { display: none; }
        @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ¢ ç¾å ´æƒ…å ±ãƒ»æ¡ä»¶å…¥åŠ›</h2>
        <div class="grid">
            <div style="grid-column: span 2;">
                <label>ç¾å ´åç§°</label>
                <input type="text" id="siteName" placeholder="ã€‡ã€‡å»ºè¨­ç¾å ´">
            </div>
            <div>
                <label>åœ°ç‚¹å</label>
                <input type="text" id="pointName" placeholder="Observation Well No.1">
            </div>
            <div>
                <label>æšæ°´é‡ Q (L/min)</label>
                <input type="number" id="inputQ_L" value="60">
            </div>
            <div>
                <label>è¦³æ¸¬è·é›¢ r (m)</label>
                <input type="number" id="inputR" value="10" step="0.1">
            </div>
            <div>
                <label>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é•· L (m)</label>
                <input type="number" id="inputL" value="5" step="0.1">
            </div>
            <div>
                <label>é–‹å§‹å‰æ°´ä½ (G.L.-m)</label>
                <input type="number" id="baseWL" value="2.50" step="0.01">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h3>
        <label>æ™‚é–“(åˆ†) ã¨ æ°´ä½(G.L.-m) ã‚’å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã¾ãŸã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <textarea id="dataInput" rows="8" placeholder="1  2.65&#10;2  2.80&#10;5  3.10&#10;10 3.35..."></textarea>
        <div class="btn-group">
            <input type="file" id="csvFile" class="hidden" accept=".csv">
            <button class="btn-load" onclick="document.getElementById('csvFile').click()">CSVèª­è¾¼</button>
            <button class="btn-calc" onclick="runAnalysis()">è§£æå®Ÿè¡Œ</button>
        </div>
    </div>

    <div id="resultsArea" class="card hidden">
        <h3>ğŸ“Š è§£æçµæœ</h3>
        <div class="result-box">
            <div class="res-item">é€æ°´é‡ä¿‚æ•° T [mÂ²/s]<span id="resT" class="res-val">-</span></div>
            <div class="res-item">é€æ°´ä¿‚æ•° k [m/s]<span id="resK" class="res-val">-</span></div>
            <div class="res-item">è²¯ç•™ä¿‚æ•° S [-]<span id="resS" class="res-val">-</span></div>
            <div class="res-item">æ±ºå®šä¿‚æ•° RÂ²<span id="resR2" class="res-val">-</span></div>
        </div>

        <div id="plotHydro"></div>
        <div id="plotJacob"></div>

        <div class="btn-group">
            <button class="btn-csv" onclick="exportCSV()">CSVä¿å­˜</button>
            <button class="btn-pdf" onclick="exportPDF()">PDFå‡ºåŠ›</button>
        </div>
    </div>
</div>

<script>
let globalData = [];
let analysisResults = {};

/**
 * è§£æå®Ÿè¡Œãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
function runAnalysis() {
    const text = document.getElementById('dataInput').value.trim();
    const baseWL = parseFloat(document.getElementById('baseWL').value);
    const Q_Lmin = parseFloat(document.getElementById('inputQ_L').value);
    const r = parseFloat(document.getElementById('inputR').value);
    const L = parseFloat(document.getElementById('inputL').value);

    if (!text) return alert("ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãŒå¿…è¦ã§ã™");

    // æšæ°´é‡ã‚’ m3/s ã«å¤‰æ›
    const Q_m3s = Q_Lmin / 1000 / 60;

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹
    const rows = text.split(/\n/);
    globalData = rows.map(row => {
        const cols = row.trim().split(/[\s,t]+/).map(v => parseFloat(v));
        if (cols.length >= 2 && !isNaN(cols[0]) && !isNaN(cols[1])) {
            return { t: cols[0], wl: cols[1], s: cols[1] - baseWL };
        }
        return null;
    }).filter(d => d !== null && d.t > 0);

    if (globalData.length < 3) return alert("è§£æã«ã¯å°‘ãªãã¨ã‚‚3ç‚¹ä»¥ä¸Šã®æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚");

    // Jacobæ³•è¨ˆç®— (log10(t) vs s)
    const logT = globalData.map(d => Math.log10(d.t));
    const points = logT.map((x, i) => [x, globalData[i].s]);
    
    // å˜ç´”ç·šå½¢å›å¸°
    const reg = ss.linearRegression(points);
    const lre = ss.linearRegressionLine(reg);
    const r2 = ss.rSquared(points, lre);

    // æ°´ç†å®šæ•°ç®—å‡º
    // deltaS = 1å¯¾æ•°å‘¨æœŸã‚ãŸã‚Šã®æ°´ä½ä½ä¸‹é‡ = å›å¸°ç›´ç·šã®å‚¾ã
    const deltaS = reg.m; 
    const T = (0.183 * Q_m3s) / deltaS;
    const k = T / L;
    
    // t0 (s=0ã¨ãªã‚‹æ™‚é–“[åˆ†])
    const logT0 = -reg.b / reg.m;
    const t0_min = Math.pow(10, logT0);
    const S = (2.25 * T * (t0_min * 60)) / Math.pow(r, 2);

    analysisResults = { T, k, S, r2, deltaS, t0_min, Q_m3s, Q_Lmin, r, L, baseWL };

    // è¡¨ç¤ºæ›´æ–°
    document.getElementById('resultsArea').classList.remove('hidden');
    document.getElementById('resT').innerText = T.toExponential(3);
    document.getElementById('resK').innerText = k.toExponential(3);
    document.getElementById('resS').innerText = S.toExponential(3);
    document.getElementById('resR2').innerText = r2.toFixed(4);

    drawPlots(logT, lre);
}

/**
 * ã‚°ãƒ©ãƒ•æç”»
 */
function drawPlots(logT, lre) {
    const timeArr = globalData.map(d => d.t);
    const wlArr = globalData.map(d => d.wl);
    const sArr = globalData.map(d => d.s);

    // 1. æ°´ä½å¤‰å‹•ã‚°ãƒ©ãƒ• (ãƒã‚¤ãƒ‰ãƒ­ã‚°ãƒ©ãƒ•)
    const traceHydro = {
        x: timeArr,
        y: wlArr,
        mode: 'lines+markers',
        name: 'è¦³æ¸¬æ°´ä½',
        line: { color: '#1a73e8', shape: 'spline' }
    };
    const layoutHydro = {
        title: 'æ°´ä½å¤‰å‹•ã‚°ãƒ©ãƒ•',
        xaxis: { title: 'çµŒéæ™‚é–“ (min)' },
        yaxis: { title: 'æ°´ä½ (G.L.-m)', autorange: 'reverse' }, // æ°´ä½ãªã®ã§ä¸‹å‘ã
        margin: { t: 50, b: 50, l: 60, r: 30 }
    };
    Plotly.newPlot('plotHydro', [traceHydro], layoutHydro);

    // 2. Jacobæ³•è§£æã‚°ãƒ©ãƒ• (ç‰‡å¯¾æ•°)
    const tracePoints = {
        x: logT,
        y: sArr,
        mode: 'markers',
        name: 'å®Ÿæ¸¬ä½ä¸‹é‡',
        marker: { color: '#5f6368' }
    };
    const traceFit = {
        x: [Math.min(...logT), Math.max(...logT)],
        y: [lre(Math.min(...logT)), lre(Math.max(...logT))],
        mode: 'lines',
        name: 'Jacobè¿‘ä¼¼ç›´ç·š',
        line: { color: '#ea4335', width: 2 }
    };
    const layoutJacob = {
        title: 'Jacobæ³•è§£æå›³',
        xaxis: { title: 'log10(çµŒéæ™‚é–“ [min])' },
        yaxis: { title: 'æ°´ä½ä½ä¸‹é‡ s [m]' },
        margin: { t: 50, b: 50, l: 60, r: 30 },
        legend: { orientation: 'h', y: -0.2 }
    };
    Plotly.newPlot('plotJacob', [tracePoints, traceFit], layoutJacob);
}

/**
 * CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
 */
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    Papa.parse(file, {
        header: false,
        complete: function(results) {
            const rows = results.data;
            let dataLines = [];
            
            rows.forEach(row => {
                if (!row[0]) return;
                const cell = String(row[0]);
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
                if (cell.startsWith('# SITE:')) document.getElementById('siteName').value = cell.replace('# SITE:', '').trim();
                if (cell.startsWith('# POINT:')) document.getElementById('pointName').value = cell.replace('# POINT:', '').trim();
                if (cell.startsWith('# Q_LMIN:')) document.getElementById('inputQ_L').value = cell.replace('# Q_LMIN:', '').trim();
                if (cell.startsWith('# R_M:')) document.getElementById('inputR').value = cell.replace('# R_M:', '').trim();
                if (cell.startsWith('# L_M:')) document.getElementById('inputL').value = cell.replace('# L_M:', '').trim();
                if (cell.startsWith('# BASEWL:')) document.getElementById('baseWL').value = cell.replace('# BASEWL:', '').trim();
                
                // æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
                if (!isNaN(parseFloat(row[0])) && !isNaN(parseFloat(row[1]))) {
                    dataLines.push(`${row[0]},${row[1]}`);
                }
            });
            
            document.getElementById('dataInput').value = dataLines.join('\n');
            runAnalysis();
        }
    });
});

/**
 * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 */
function exportCSV() {
    const site = document.getElementById('siteName').value || 'site';
    const point = document.getElementById('pointName').value || 'point';
    
    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«åŸ‹ã‚è¾¼ã‚€
    let csvContent = [
        `# SITE: ${site}`,
        `# POINT: ${point}`,
        `# Q_LMIN: ${document.getElementById('inputQ_L').value}`,
        `# R_M: ${document.getElementById('inputR').value}`,
        `# L_M: ${document.getElementById('inputL').value}`,
        `# BASEWL: ${document.getElementById('baseWL').value}`,
        "Time(min),WaterLevel(m),Drawdown(m)"
    ].join("\n") + "\n";
    
    csvContent += globalData.map(d => `${d.t},${d.wl},${d.s}`).join("\n");
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `${site}_${point}_data.csv`);
    link.click();
}

/**
 * PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 */
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const site = document.getElementById('siteName').value || 'Unknown Site';
    const point = document.getElementById('pointName').value || 'Unknown Point';

    doc.setFontSize(18);
    doc.text("Aquifer Test Analysis Report", 14, 20);
    
    doc.setFontSize(12);
    doc.text(`Site: ${site}`, 14, 30);
    doc.text(`Point: ${point}`, 14, 37);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 44);

    doc.autoTable({
        startY: 50,
        head: [['Property', 'Value', 'Unit']],
        body: [
            ['Pumping Rate (Q)', analysisResults.Q_Lmin, 'L/min'],
            ['Distance (r)', analysisResults.r, 'm'],
            ['Screen Length (L)', analysisResults.L, 'm'],
            ['Initial WL', analysisResults.baseWL, 'G.L.-m'],
            ['Transmissivity (T)', analysisResults.T.toExponential(3), 'm2/s'],
            ['Hydraulic Conductivity (k)', analysisResults.k.toExponential(3), 'm/s'],
            ['Storage Coefficient (S)', analysisResults.S.toExponential(3), '-'],
            ['R-Squared', analysisResults.r2.toFixed(4), '-']
        ]
    });

    doc.text("Summary Table (Top 10)", 14, doc.lastAutoTable.finalY + 10);
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 15,
        head: [['Time(min)', 'WL(m)', 'Drawdown(s)']],
        body: globalData.slice(0, 10).map(d => [d.t, d.wl.toFixed(2), d.s.toFixed(2)])
    });

    doc.save(`${site}_report.pdf`);
}
</script>

</body>
</html>
